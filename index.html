<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Presentation</title>

    
    
    <link rel="stylesheet" href="vendor/pico.min.css"/>

    
    <style>
        
        :root {
            
            --primary: #2563eb;
            --secondary: #6b7280;
            --background: #ffffff;
            --surface: #f8f9fa;
            --text: #1a1a1a;
            --text-secondary: #6c757d;

            --prgb: 37, 99, 235;
            --srgb: 107, 114, 128;
            --trgb: 26, 26, 26;

            
            --pico-primary: #2563eb;
            --pico-secondary: #6b7280;
            --pico-primary-background: #2563eb;
            --pico-primary-inverse: #ffffff;
            --pico-primary-focus: rgba(37, 99, 235, 0.25);
            --pico-font-family: system-ui, -apple-system, sans-serif;
            --pico-border-radius: 6px;

            --ad: 0.6s;
        }

        
        #progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: var(--primary);
            width: 0%;
            z-index: 100;
            transition: width 0.3s ease;
        }

        #nav-controls {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
            z-index: 90;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #nav-controls:hover {
            opacity: 1;
        }

        #nav-controls button {
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        #nav-controls button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(var(--prgb), 0.3);
        }

        #nav-controls button svg {
            transition: transform 0.3s ease;
        }

        #nav-controls button:active svg {
            transform: scale(0.9);
        }

        

        
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(var(--trgb), 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-indicator p {
            margin: 0;
            color: var(--primary);
            font-weight: 600;
        }

        
        .layout-wrapper {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 1.25rem;
            align-items: start;
        }

        
        .layout-wrapper > * {
            min-width: 0;
        }

        #toc-nav {
            position: sticky;
            top: 20px;
            
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            padding: 0.4rem;
            scrollbar-gutter: stable both-edges;
            scrollbar-width: thin;
        }

        
        #toc-nav h4 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        #toc-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: block;
        }
        
        #toc-nav li a {
            display: block;
            padding: 0.2rem 0.3rem;
            margin-bottom: 0.1rem;
            text-decoration: none;
            border-radius: var(--pico-border-radius);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1.2;
            overflow-wrap: normal;
            word-break: normal;
            white-space: normal;
            hyphens: none;
            border-left: 3px solid transparent;
            max-width: 100%;
            width: 100%;
            position: relative;
        }

        #toc-nav li a:hover {
            background-color: var(--surface);
        }

        #toc-nav li a.active {
            background-color: rgba(var(--prgb), 0.1);
            color: var(--primary);
            font-weight: 700;
            border-left-color: var(--primary);
        }
        
        
        #toc-nav > ul > li {
            position: relative;
        }

        #toc-nav ul ul {
            padding-left: 0.5rem;
            margin-top: 0.15rem;
            margin-bottom: 0.15rem;
            list-style: none;
            border-left: none;
        }

        
        #toc-nav ul ul::before,
        #toc-nav ul ul::after { content: none; }

        #toc-nav li ul li {
            position: relative;
            border-left: none;
        }

        
        #toc-nav li ul li::before,
        #toc-nav li ul li::after { content: none; }

        #toc-nav li a:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        #toc-nav li ul li a {
            font-size: 0.65rem;
            color: var(--text-secondary);
            padding: 0.15rem 0.3rem 0.15rem 0.5rem;
            margin-left: 0.2rem;
        }

        
        #toc-nav li ul li a.active {
             background-color: rgba(var(--prgb), 0.08);
             color: var(--primary);
             font-weight: 600;
        }

        
        .presentation-mode {
            background: var(--background);
        }

        .presentation-mode .layout-wrapper {
            grid-template-columns: 1fr !important;
            max-width: none !important;
            padding: 0 4rem;
        }

        .presentation-mode #toc-nav {
            display: none !important;
        }

        .presentation-mode #nav-controls {
            opacity: 1 !important;
            z-index: 1000;
        }

        .presentation-mode .hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .presentation-mode section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 4rem 0;
        }

        @media (max-width: 992px) {
            .layout-wrapper {
                grid-template-columns: 1fr;
            }
            #toc-nav {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .presentation-mode .layout-wrapper {
                padding: 0 2rem;
            }

            .presentation-mode .hero h1 {
                font-size: 2.5rem;
            }
        }

        
        body {
            scroll-behavior: smooth;
            background: var(--background);
            color: var(--text);
        }

        .hero {
            text-align: center;
            padding: 6rem 2rem 4rem;
            margin-bottom: 3rem;
            background: linear-gradient(145deg, var(--background) 0%, var(--surface) 50%, var(--background) 100%);
            color: var(--text);
            position: relative;
            border-bottom: 3px solid var(--surface);
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(var(--prgb), 0.04) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(var(--prgb), 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(var(--prgb), 0.02) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
            line-height: 1.1;
            letter-spacing: -0.02em;
            color: var(--text);
        }

        .hero p {
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
            color: var(--text-secondary);
            margin-bottom: 3rem;
            position: relative;
            z-index: 1;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        
        .hero a[role="button"] {
            background: var(--primary);
            color: white;
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(var(--prgb), 0.3);
            border: 2px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }

        .hero a[role="button"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .hero a[role="button"]:hover::before {
            left: 100%;
        }

        .hero a[role="button"]:hover {
            background: var(--primary);
            filter: brightness(1.1);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(var(--prgb), 0.4);
        }

        .hero a[role="button"]:active {
            transform: translateY(-1px) scale(1.02);
        }

        
        .hero-highlights {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 3rem 0;
            flex-wrap: wrap;
        }

        .hero-highlight {
            background: var(--surface);
            backdrop-filter: blur(10px);
            border: 1px solid var(--secondary);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .hero-highlight:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .highlight-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, color-mix(in srgb, var(--primary) 80%, black) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .highlight-metric {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .highlight-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .hero-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .hero a[role="button"].btn-secondary {
            background: var(--surface);
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 4px 15px rgba(var(--prgb), 0.2);
        }

        .hero a[role="button"].btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--prgb), 0.3);
        }

        .hero a[role="button"].btn-secondary::before {
            background: linear-gradient(90deg, transparent, rgba(var(--prgb), 0.3), transparent);
        }

        
        .hero a[role="button"].btn-secondary {
            animation: none;
        }


        
        @keyframes heroPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(var(--prgb), 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 20px rgba(var(--prgb), 0.4);
            }
        }

        .hero a[role="button"] {
            animation: heroPulse 3s ease-in-out infinite;
        }

        .hero a[role="button"]:hover {
            animation: none;
        }

        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .hero .floating-element {
            animation: float 6s ease-in-out infinite;
        }

        .hero .floating-element:nth-child(2) {
            animation-delay: -2s;
        }

        .hero .floating-element:nth-child(3) {
            animation-delay: -4s;
        }

        
        @keyframes titleFadeIn {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            animation: titleFadeIn 1s ease-out;
        }

        .hero p {
            animation: titleFadeIn 1s ease-out 0.3s both;
        }

        .hero-highlights {
            animation: titleFadeIn 1s ease-out 0.6s both;
        }

        .hero-actions {
            animation: titleFadeIn 1s ease-out 0.9s both;
        }

        
        @media (max-width: 768px) {
            .hero-highlights {
                gap: 1rem;
            }

            .hero-highlight {
                min-width: 100px;
                padding: 1rem;
            }

            .highlight-value {
                font-size: 1.5rem;
            }

            .hero-actions {
                flex-direction: column;
                align-items: center;
            }

            .hero a[role="button"] {
                min-width: 250px;
                text-align: center;
            }
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-left: 5px solid var(--primary);
            padding: 2rem 1.5rem;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card .value {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 0.5rem;
        }

        .kpi-card .label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
        }

        section {
            padding: 3rem 0;
            border-bottom: 1px solid var(--pico-muted-border-color);
        }

        
        section[id],
        article.subsection[id] {
            scroll-margin-top: 28px;
        }

        
        .subsection {
            padding-left: 1.5rem;
            margin-top: 2.5rem;
            border-left: 2px solid var(--pico-muted-border-color);
        }
        
        section:last-of-type {
            border-bottom: none;
        }
        
        figure {
            margin: 2rem 0;
        }

        figure img {
            border-radius: var(--pico-border-radius);
            box-shadow: var(--pico-card-box-shadow);
            max-width: 100%;
            height: auto;
        }

        
        .animated-section {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity var(--ad) ease-out, transform var(--ad) ease-out;
        }

        .animated-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        
        .mermaid {
            overflow-x: auto;
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 2rem 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        
        [data-theme="dark"] .mermaid {
            --mermaid-text-color: #ffffff;
        }

        
        [data-theme="dark"] .mermaid svg text,
        [data-theme="dark"] .mermaid svg tspan {
            fill: #ffffff !important;
        }
        [data-theme="dark"] .mermaid svg foreignObject div {
            color: #ffffff !important;
        }

        
        .mermaid svg text,
        .mermaid svg tspan {
            font-family: var(--pico-font-family);
        }

        .mermaid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 16px 16px 0 0;
            opacity: 0.8;
        }

        .mermaid:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .mermaid:hover::before {
            opacity: 1;
            height: 4px;
        }

        .mermaid svg {
            display: block;
            max-width: 100%;
            height: auto;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: contrast(1.05) saturate(1.1);
            overflow: visible;
        }

        .mermaid:hover svg {
            filter: brightness(1.05) contrast(1.1) saturate(1.15);
            transform: scale(1.005);
        }

        
        [data-theme="dark"] .mermaid svg {
            filter: none;
        }

        
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(var(--trgb), 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-sizing: border-box;
        }

        #modal-overlay.show {
            display: flex;
        }

        #modal-content {
            background: transparent;
            border-radius: 0;
            max-width: 100vw;
            max-height: 100vh;
            overflow: hidden;
            position: relative;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        #modal-close {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--pico-primary);
            color: var(--pico-primary-inverse);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
            z-index: 2001;
        }

        #modal-close:hover {
            background: var(--pico-primary-hover);
            transform: scale(1.1);
        }

        #modal-body {
            padding: 0;
            text-align: center;
            max-width: calc(100vw - 2rem);
            max-height: calc(100vh - 2rem);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #modal-body img {
            width: min(96vw, 1600px);
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--pico-border-radius);
        }

        #modal-body .mermaid-modal {
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-radius: 20px;
            padding: 2rem;
            margin: 0;
            max-width: 96vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow:
                0 25px 80px rgba(0, 0, 0, 0.2),
                0 0 0 1px var(--secondary);
            position: relative;
        }

        #modal-body .mermaid-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            border-radius: 20px 20px 0 0;
        }

        #modal-body .mermaid-modal svg {
            width: min(94vw, 1600px) !important;
            height: auto !important;
            display: block !important;
            margin: 0 auto !important;
            max-height: 85vh !important;
            visibility: visible !important;
            opacity: 1 !important;
            filter: brightness(1.1) contrast(1.1) saturate(1.2);
            transition: all 0.3s ease;
        }

        
        figure img,
        .mermaid {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        figure img:hover,
        .mermaid:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        
        dfn {
            text-decoration: underline dotted;
            text-decoration-color: var(--pico-primary);
            cursor: help;
            position: relative;
            font-style: normal;
        }

        dfn:hover::after {
            content: attr(data-definition);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            width: 280px;
            background: var(--pico-primary);
            color: var(--pico-primary-inverse);
            border-radius: var(--pico-border-radius);
            font-size: 0.875rem;
            text-align: left;
            line-height: 1.4;
            white-space: normal;
            z-index: 10;
            box-shadow: var(--pico-card-box-shadow);
            pointer-events: none;
        }

        .glossary-list dt {
            font-weight: bold;
            color: var(--pico-primary);
        }

        .glossary-list dd {
            margin-left: 1rem;
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 2px solid var(--pico-muted-border-color);
        }

        .landing-hero {
            text-align: center;
            padding: 6rem 1rem 2rem;
            background: linear-gradient(180deg, color-mix(in srgb, var(--surface) 60%, transparent) 0%, transparent 100%);
            border-radius: var(--pico-border-radius);
        }
        .landing-brand {
            display: inline-block;
            font-weight: 800;
            letter-spacing: .02em;
            color: var(--primary);
            margin-bottom: .5rem;
        }
        .landing-sub {
            color: var(--text-secondary);
            margin: 0 auto 1.5rem;
            max-width: 60ch;
        }
        .landing-actions {
            display: flex; gap: .75rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem;
        }

        .landing-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .lang-switch {
            display: flex;
            gap: 0.25rem;
            background: var(--surface);
            border: 1px solid var(--secondary);
            border-radius: var(--pico-border-radius);
            padding: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: calc(var(--pico-border-radius) - 2px);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 2.5rem;
        }

        .lang-btn:hover {
            background: var(--primary);
            color: white;
        }

        .lang-btn.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        
        .btn-primary, .btn-secondary {
            display: inline-block; padding: .75rem 1.25rem; border-radius: var(--pico-border-radius);
            text-decoration: none; border: 1px solid transparent; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { filter: brightness(0.95); }
        .btn-secondary { background: var(--surface); color: var(--text); border-color: var(--secondary); }
        .btn-secondary:hover { background: color-mix(in srgb, var(--surface) 85%, var(--secondary)); }
        .info-chips { display: flex; gap: .5rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem; }
        .chip { padding: .35rem .6rem; border: 1px solid var(--secondary); border-radius: 999px; font-size: .9rem; color: var(--text-secondary); }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .card { background: var(--surface); border: 1px solid var(--secondary); border-radius: var(--pico-border-radius); padding: 1rem; }
        .fade-in { animation: fadeIn .4s ease both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>
    
    
    <div id="progress-bar"></div>
    

    
    <div id="nav-controls">
        <button id="upload-json" aria-label="Upload JSON file" title="Upload JSON (Ctrl+U)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
        </button>
        <button id="theme-toggle" aria-label="Toggle theme" title="Toggle Light/Dark Mode (T)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"></path>
            </svg>
        </button>
        <button id="fullscreen-toggle" aria-label="Toggle fullscreen" title="Fullscreen (F)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </button>
        <button id="prev-section" aria-label="Previous section" title="Previous (←)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
        </button>
        <button id="next-section" aria-label="Next section" title="Next (→)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        </button>
    </div>

    
    <input type="file" id="json-file-input" accept=".json" style="display: none;">

    
    <div id="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading presentation...</p>
    </div>

    <div class="layout-wrapper container">
        
        <main id="presentation-content"></main>

        <nav id="toc-nav">
            <ul id="toc-list"></ul>
        </nav>
    </div>

    
    <div id="modal-overlay">
        <div id="modal-content">
            <button id="modal-close" aria-label="Fermer">&times;</button>
            <div id="modal-body">
                
            </div>
        </div>
    </div>


    
    
    <script src="vendor/mermaid.min.js"></script>

    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const config = {
                contentEl: document.getElementById('presentation-content'),
                tocEl: document.getElementById('toc-list'),
                progressBarEl: document.getElementById('progress-bar'),
            };

            // Global variable to store current presentation data
            let currentPresentationData = null;

            // Navigation mode state (linear only)
            const currentNavigationMode = 'linear';

            // AbortController for cleaning up event listeners on reload
            let abortController = new AbortController();

            // Simple translation dictionary for landing page
            const translations = {
                en: {
                    title: "Load Your Presentation JSON",
                    subtitle: "Local, secure, and fully open source. No servers. No tracking. Works on GitHub Pages.",
                    select: "Select JSON",
                    github: "View on GitHub",
                    chipLocal: "🔒 All local",
                    chipJson: "🧩 JSON-driven",
                    chipMermaid: "🖼️ Mermaid supported",
                    chipLicense: "📄 MIT License",
                    howTitle: "How it works",
                    howCopy: "Click <strong>Select JSON</strong> to render your presentation instantly. Or host this page on GitHub Pages and pass <code>?data=URL</code> to a JSON file.",
                    secTitle: "Security",
                    secCopy: "Everything runs in your browser. No data leaves your machine. External links open in a new tab with <code>rel=\"noopener\"</code>.",
                    licTitle: "License",
                    licCopy: "Distributed under the <strong>MIT License</strong>. See <a href=\"LICENSE\" target=\"_blank\" rel=\"noopener\">LICENSE</a> for details."
                },
                fr: {
                    title: "Chargez votre JSON de présentation",
                    subtitle: "Local, sécurisé et entièrement open source. Aucun serveur. Aucun suivi. Fonctionne sur GitHub Pages.",
                    select: "Sélectionner JSON",
                    github: "Voir sur GitHub",
                    chipLocal: "🔒 Tout local",
                    chipJson: "🧩 Piloté par JSON",
                    chipMermaid: "🖼️ Mermaid supporté",
                    chipLicense: "📄 Licence MIT",
                    howTitle: "Comment ça marche",
                    howCopy: "Cliquez sur <strong>Sélectionner JSON</strong> pour rendre votre présentation instantanément. Ou hébergez cette page sur GitHub Pages et passez <code>?data=URL</code> à un fichier JSON.",
                    secTitle: "Sécurité",
                    secCopy: "Tout fonctionne dans votre navigateur. Aucune donnée ne quitte votre machine. Les liens externes s'ouvrent dans un nouvel onglet avec <code>rel=\"noopener\"</code>.",
                    licTitle: "Licence",
                    licCopy: "Distribué sous la <strong>licence MIT</strong>. Voir <a href=\"LICENSE\" target=\"_blank\" rel=\"noopener\">LICENSE</a> pour les détails."
                }
            };

            // Current language for landing page (independent of presentation)
            let currentLandingLanguage = 'fr'; // Default to French to match the page

            // Throttle utility function for scroll performance
            function throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }

            /**
             * Utility: Detects invalid CSS values (e.g., undefined/null/empty/NaN strings)
             */
            function isInvalidCssValue(value) {
                if (value === undefined || value === null) return true;
                const v = (typeof value === 'string' ? value : String(value)).trim();
                return v === '' || v === 'undefined' || v === 'null' || v === 'NaN';
            }

            /**
             * Utility: Safely set a CSS variable only if the value is valid
             */
            function safeSetCssVar(varName, value) {
                if (!isInvalidCssValue(value)) {
                    document.documentElement.style.setProperty(varName, value);
                }
            }

            /**
             * Applies translations to landing page elements
             */
            function applyLandingTranslations(language) {
                const langData = translations[language];
                if (!langData) return;

                // Update all elements with data-i18n attributes
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (langData[key]) {
                        if (element.tagName === 'INPUT' && element.type === 'submit') {
                            element.value = langData[key];
                        } else {
                            element.innerHTML = langData[key];
                        }
                    }
                });

                // Update language button states
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-lang') === language);
                });

                // Store preference
                localStorage.setItem('landing-language', language);
            }

            /**
             * Sets up landing page language toggle
             */
            function setupLandingLanguageToggle() {
                const langBtns = document.querySelectorAll('.lang-btn');

                langBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const lang = btn.getAttribute('data-lang');
                        if (lang && translations[lang]) {
                            currentLandingLanguage = lang;
                            applyLandingTranslations(lang);
                        }
                    });
                });

                // Load saved preference
                const savedLang = localStorage.getItem('landing-language');
                if (savedLang && translations[savedLang]) {
                    currentLandingLanguage = savedLang;
                    applyLandingTranslations(savedLang);
                } else {
                    // Apply default language
                    applyLandingTranslations(currentLandingLanguage);
                }
            }

            

            /**
             * Loads presentation data from various sources
             */
            async function loadPresentationData(uploadedData = null) {
                // If we have uploaded data, use it directly
                if (uploadedData) { return uploadedData; }

                // Check for data parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');

                if (dataParam) {
                    try {
                        const response = await fetch(dataParam);
                        if (response.ok) { const data = await response.json(); return data; }
                    } catch (error) {
                        // Ignore and fall through to landing page
                    }
                }

                // No default load path: force landing page
                throw new Error('No presentation provided. Upload a JSON file or pass ?data=URL to begin.');
            }

            /**
             * Processes navigation configuration and reorders content if needed (linear mode only)
             */
            function processNavigationOrder(data, targetMode = null) {
                const mode = targetMode || data.navigation?.mode || 'linear';

                if (mode === 'linear') {
                    return data; // No changes needed
                }

                if (mode === 'ordered' && data.navigation?.order) {
                    return reorderContentByArray(data, data.navigation.order);
                }

                return data; // Fallback to linear
            }

            /**
             * Helper function to reorder content based on an array of IDs
             */
            function reorderContentByArray(data, orderArray) {
                // Create a map of all sections and subsections by ID
                const contentMap = new Map();
                data.sections.forEach(section => {
                    contentMap.set(section.id, { type: 'section', data: section });
                    if (section.subsections) {
                        section.subsections.forEach(sub => {
                            contentMap.set(sub.id, { type: 'subsection', data: sub, parentId: section.id });
                        });
                    }
                });

                // Reorder sections and subsections according to orderArray
                const orderedSections = [];
                const processedIds = new Set();

                orderArray.forEach(id => {
                    const item = contentMap.get(id);
                    if (item) {
                        if (item.type === 'section') {
                            // Create a copy of the section
                            const sectionCopy = { ...item.data };

                            // If section has subsections, reorder them according to orderArray
                            if (sectionCopy.subsections && orderArray) {
                                const orderedSubs = [];
                                orderArray.forEach(subId => {
                                    const subItem = contentMap.get(subId);
                                    if (subItem && subItem.type === 'subsection' && subItem.parentId === id) {
                                        orderedSubs.push(subItem.data);
                                        processedIds.add(subId);
                                    }
                                });
                                // Add any remaining subsections not in navigation order
                                if (sectionCopy.subsections) {
                                    sectionCopy.subsections.forEach(sub => {
                                        if (!processedIds.has(sub.id)) {
                                            orderedSubs.push(sub);
                                        }
                                    });
                                }
                                sectionCopy.subsections = orderedSubs;
                            }

                            orderedSections.push(sectionCopy);
                            processedIds.add(id);
                        } else if (item.type === 'subsection') {
                            // Handle standalone subsections (though this is rare)
                            // For now, we'll skip them as they should be handled within their parent sections
                        }
                    }
                });

                // Add any sections not in the navigation order
                data.sections.forEach(section => {
                    if (!processedIds.has(section.id)) {
                        orderedSections.push(section);
                    }
                });

                return { ...data, sections: orderedSections };
            }

            /**
             * Main function to initialize the presentation
             */
            async function init(uploadedData = null) {
                try {
                    const data = await loadPresentationData(uploadedData);
                    const processedData = processNavigationOrder(data);
                    currentPresentationData = processedData; // Store for potential reloading
                    applyTheme(processedData.theme);
                    document.title = processedData.title;

                    renderPresentation(processedData);
                    processGlossary(processedData.glossary); // Automatically highlight terms
                    initializeMermaid();
                    setupEventListeners(processedData.sections);
                    // Setup interactive elements after content is loaded
                    setTimeout(setupInteractiveElements, 500);
                } catch (error) {
                    const repoUrl = getGitHubRepoUrl();
                    config.contentEl.innerHTML = `
                        <section class="landing-hero fade-in">
                            <div class="landing-controls">
                                <div class="lang-switch" role="group" aria-label="Language">
                                    <button class="lang-btn" data-lang="en">EN</button>
                                    <button class="lang-btn" data-lang="fr">FR</button>
                                </div>
                            </div>
                            <div class="landing-brand">📑 Narrative Presentation</div>
                            <h1 data-i18n="title">Load Your Presentation JSON</h1>
                            <p class="landing-sub" data-i18n="subtitle">Local, secure, and fully open source. No servers. No tracking. Works on GitHub Pages.</p>
                            <div class="landing-actions">
                                <input type="file" id="fallback-json-input" accept=".json" style="display:none;">
                                <button id="fallback-upload-btn" class="btn-primary" data-i18n="select">Select JSON</button>
                                ${repoUrl ? `<a href="${repoUrl}" target="_blank" rel="noopener" class="btn-secondary" data-i18n="github">View on GitHub</a>` : ''}
                                <a href="README.md" target="_blank" rel="noopener" class="btn-secondary">README</a>
                            </div>
                            <div class="info-chips">
                                <span class="chip" data-i18n="chipLocal">🔒 All local</span>
                                <span class="chip" data-i18n="chipJson">🧩 JSON-driven</span>
                                <span class="chip" data-i18n="chipMermaid">🖼️ Mermaid supported</span>
                                <span class="chip" data-i18n="chipLicense">📄 MIT License</span>
                            </div>
                        </section>

                        <section class="feature-grid fade-in" style="animation-delay: .1s;">
                            <article class="card">
                                <h3 data-i18n="howTitle">How it works</h3>
                                <p data-i18n="howCopy">Click <strong>Select JSON</strong> to render your presentation instantly. Or host this page on GitHub Pages and pass <code>?data=URL</code> to a JSON file.</p>
                            </article>
                            <article class="card">
                                <h3 data-i18n="secTitle">Security</h3>
                                <p data-i18n="secCopy">Everything runs in your browser. No data leaves your machine. External links open in a new tab with <code>rel=\"noopener\"</code>.</p>
                            </article>
                            <article class="card">
                                <h3 data-i18n="licTitle">License</h3>
                                <p data-i18n="licCopy">Distributed under the <strong>MIT License</strong>. See <a href=\"LICENSE\" target=\"_blank\" rel=\"noopener\">LICENSE</a> for details.</p>
                            </article>
                        </section>
                    `;

                    // Setup fallback upload functionality
                    setupFallbackUpload();

                    // Setup landing page toggles
                    setupLandingLanguageToggle();
                }
            }

            /**
             * Sets up fallback upload functionality when presentation.json is not found
             */
            function setupFallbackUpload() {
                const uploadBtn = document.getElementById('fallback-upload-btn');
                const fileInput = document.getElementById('fallback-json-input');

                if (!uploadBtn || !fileInput) return;

                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!file.name.toLowerCase().endsWith('.json')) {
                        alert('Please select a JSON file.');
                        return;
                    }

                    try {
                        uploadBtn.textContent = 'Loading...';
                        uploadBtn.disabled = true;

                        const fileContent = await readFileAsText(file);
                        const jsonData = JSON.parse(fileContent);

                        // Validate basic structure
                        if (!jsonData.title || !jsonData.sections) {
                            throw new Error('Invalid presentation format. Missing required fields (title, sections).');
                        }

                        // Initialize with uploaded data (navigation processing happens in init)
                        await init(jsonData);
                    } catch (err) {
                        alert(err.message || 'Failed to load the selected file.');
                    } finally {
                        uploadBtn.textContent = 'Upload JSON';
                        uploadBtn.disabled = false;
                        fileInput.value = '';
                    }
                });
            }

            function getGitHubRepoUrl() {
                if (window.GITHUB_REPO_URL) return window.GITHUB_REPO_URL;
                const { host, pathname } = window.location;
                if (!host.endsWith('github.io')) return '';
                const parts = pathname.split('/').filter(Boolean);
                const user = host.split('.')[0];
                const repo = parts.length > 0 ? parts[0] : '';
                if (!user || !repo) return '';
                return `https://github.com/${user}/${repo}`;
            }

            /**
             * Reloads the presentation with new data
             */
            async function reloadPresentation(newData) {
                try {
                    // Clean up previous event listeners
                    abortController.abort();
                    abortController = new AbortController();

                    // Clear existing content
                    config.contentEl.innerHTML = '';
                    config.tocEl.innerHTML = '';

                    // Process navigation order and reinitialize
                    const processedData = processNavigationOrder(newData);
                    currentPresentationData = processedData;

                    applyTheme(processedData.theme);
                    document.title = processedData.title;

                    renderPresentation(processedData);
                    processGlossary(processedData.glossary);
                    initializeMermaid();
                    setupEventListeners(processedData.sections);

                    // Re-render Mermaid diagrams after content is loaded
                    setTimeout(() => {
                        renderMermaidDiagrams();
                        setupInteractiveElements();
                    }, 100);
                } catch (error) { alert('Error loading the presentation file. Please check the JSON format.'); }
            }
            
            /**
             * Helper function to convert hex color to RGB values
             */
            function hexToRgb(hex) {
                if (!hex) return '37, 99, 235';
                const input = String(hex).trim();
                // Handle rgb()/rgba()
                if (/^rgba?\(/i.test(input)) {
                    try {
                        const parts = input
                            .replace(/^rgba?\(/i, '')
                            .replace(/\)\s*$/i, '')
                            .split(',')
                            .map(p => parseFloat(p.trim()));
                        const r = Math.round(parts[0] || 0);
                        const g = Math.round(parts[1] || 0);
                        const b = Math.round(parts[2] || 0);
                        return `${r}, ${g}, ${b}`;
                    } catch (_) {
                        return '37, 99, 235';
                    }
                }
                // Handle #rgb and #rrggbb
                const short = /^#?([a-f\d])([a-f\d])([a-f\d])$/i.exec(input);
                if (short) {
                    const r = parseInt(short[1] + short[1], 16);
                    const g = parseInt(short[2] + short[2], 16);
                    const b = parseInt(short[3] + short[3], 16);
                    return `${r}, ${g}, ${b}`;
                }
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(input);
                return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '37, 99, 235';
            }

            /**
             * Applies theme settings from the JSON file
             */
            function applyTheme(theme) {
                if (!theme) return;

                // Store old theme for Mermaid re-rendering
                const oldTheme = document.documentElement.getAttribute('data-theme');

                // Set light/dark mode
                const newTheme = theme.mode || 'auto';
                document.documentElement.setAttribute('data-theme', newTheme);

                // Set custom colors by updating CSS variables
                if (theme.colors) {
                    // Normalize theme keys (support both textSecondary and text-secondary)
                    const baseColors = {
                        primary: theme.colors.primary,
                        secondary: theme.colors.secondary,
                        background: theme.colors.background,
                        surface: theme.colors.surface,
                        text: theme.colors.text,
                        textSecondary: theme.colors.textSecondary || theme.colors['text-secondary']
                    };

                    // Compute effective colors based on mode (handles 'auto' at initial load)
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isDark = newTheme === 'dark' || (newTheme === 'auto' && prefersDark);
                    const colors = { ...baseColors };
                    if (isDark) {
                        colors.background = '#1a1a1a';
                        colors.surface = '#2a2a2a';
                        colors.text = '#ffffff';
                        colors.textSecondary = '#a1a1aa';
                    }

                    // Read current CSS vars for safe fallbacks
                    const currentVar = (name, fallback) => {
                        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
                        return isInvalidCssValue(v) ? fallback : v || fallback;
                    };

                    const effective = {
                        primary: !isInvalidCssValue(colors.primary) ? colors.primary : currentVar('--primary', '#2563eb'),
                        secondary: !isInvalidCssValue(colors.secondary) ? colors.secondary : currentVar('--secondary', '#6b7280'),
                        background: !isInvalidCssValue(colors.background) ? colors.background : currentVar('--background', '#ffffff'),
                        surface: !isInvalidCssValue(colors.surface) ? colors.surface : currentVar('--surface', '#f8f9fa'),
                        text: !isInvalidCssValue(colors.text) ? colors.text : currentVar('--text', '#1a1a1a'),
                        textSecondary: !isInvalidCssValue(colors.textSecondary) ? colors.textSecondary : currentVar('--text-secondary', '#6c757d')
                    };

                    // Set simplified color palette (guarded)
                    safeSetCssVar('--primary', effective.primary);
                    safeSetCssVar('--secondary', effective.secondary);
                    safeSetCssVar('--background', effective.background);
                    safeSetCssVar('--surface', effective.surface);
                    safeSetCssVar('--text', effective.text);
                    safeSetCssVar('--text-secondary', effective.textSecondary);

                    // Set RGB version for gradients and overlays (guarded)
                    safeSetCssVar('--prgb', hexToRgb(effective.primary));
                    safeSetCssVar('--srgb', hexToRgb(effective.secondary));
                    safeSetCssVar('--trgb', hexToRgb(effective.text));

                    // Backward compatibility variables
                    safeSetCssVar('--glass-bg', `rgba(${hexToRgb(effective.surface)}, 0.8)`);
                    safeSetCssVar('--glass-border', `rgba(${hexToRgb(effective.secondary)}, 0.3)`);

                    // PicoCSS compatibility variables
                    safeSetCssVar('--pico-primary', effective.primary);
                    safeSetCssVar('--pico-secondary', effective.secondary);
                    safeSetCssVar('--pico-primary-background', effective.primary);
                    safeSetCssVar('--pico-primary-inverse', 'white');
                    safeSetCssVar('--pico-primary-focus', `rgba(${hexToRgb(effective.primary)}, 0.25)`);
                    safeSetCssVar('--pico-primary-hover', `color-mix(in srgb, ${effective.primary} 90%, black)`);
                    safeSetCssVar('--pico-h5-color', effective.text);
                    safeSetCssVar('--pico-muted-border-color', effective.secondary);
                    safeSetCssVar('--pico-del-color', effective.primary);
                    safeSetCssVar('--pico-code-background-color', effective.surface);
                    safeSetCssVar('--pico-code-border-color', effective.secondary);
                }

                // Re-render Mermaid diagrams if theme changed (but not during initial load)
                if (oldTheme && oldTheme !== newTheme) {
                    setTimeout(() => {
                        reRenderMermaidDiagrams();
                    }, 100);
                }
            }

            /**
             * Renders the entire presentation structure from JSON data
             */
            function renderPresentation(data) {
                let html = '';
                // Render Hero
                if (data.hero) {
                    let highlightsHtml = '';
                    if (data.hero.highlights && data.hero.highlights.length > 0) {
                        highlightsHtml = '<div class="hero-highlights">';
                        data.hero.highlights.forEach((highlight, index) => {
                            highlightsHtml += `
                                <div class="hero-highlight floating-element" style="animation-delay: ${index * 0.5}s">
                                    <div class="highlight-value">${highlight.value}</div>
                                    <div class="highlight-metric">${highlight.metric}</div>
                                    <div class="highlight-label">${highlight.label}</div>
                                </div>
                            `;
                        });
                        highlightsHtml += '</div>';
                    }

                    html += `
                        <header class="hero animated-section">
                            <h1>${data.hero.title}</h1>
                            <p class="pico-color-secondary">${data.hero.subtitle}</p>
                            ${highlightsHtml}
                            <div class="hero-actions">
                                ${data.hero.callToActions ? data.hero.callToActions.map(action => `
                                    <a href="${action.link}" role="button" class="${action.primary ? 'btn-primary' : 'btn-secondary'}" ${action.link.startsWith('http') ? 'target="_blank" rel="noopener"' : ''}>
                                        ${action.text}
                                    </a>
                                `).join('') : ''}
                                ${data.hero.callToAction ? `<a href="${data.hero.callToAction.link}" role="button" ${data.hero.callToAction.link.startsWith('http') ? 'target="_blank" rel="noopener"' : ''}>${data.hero.callToAction.text}</a>` : ''}
                            </div>
                        </header>
                    `;
                }

                // Render Sections and TOC
                let tocHtml = '';
                data.sections.forEach(section => {
                    let sectionContent = `<section id="${section.id}" class="animated-section">
                                            <h2>${section.title}</h2>
                                            ${section.content.map(renderContentBlock).join('')}`;

                    let tocEntry = `<li><a href="#${section.id}" data-section-id="${section.id}">${section.title}</a>`;

                    // Handle subsections
                    if (section.subsections && section.subsections.length > 0) {
                        tocEntry += '<ul>';
                        section.subsections.forEach(sub => {
                            tocEntry += `<li><a href="#${sub.id}" data-section-id="${sub.id}">${sub.title}</a></li>`;

                            sectionContent += `<article id="${sub.id}" class="subsection">
                                                 <h3>${sub.title}</h3>
                                                 ${sub.content.map(renderContentBlock).join('')}
                                               </article>`;
                        });
                        tocEntry += '</ul>';
                    }

                    tocEntry += '</li>';
                    sectionContent += `</section>`;

                    html += sectionContent;
                    tocHtml += tocEntry;
                });

                config.contentEl.innerHTML = html;
                config.tocEl.innerHTML = tocHtml;
            }

            /**
             * Processes markdown-style links [text](url) in paragraph text
             */
            function processMarkdownLinks(text) {
                return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    const isExternal = url.startsWith('http://') || url.startsWith('https://');
                    const attributes = isExternal ? ' target="_blank" rel="noopener"' : '';
                    return `<a href="${url}"${attributes}>${text}</a>`;
                });
            }

            /**
             * Renders a single content block based on its type
             */
            function renderContentBlock(block) {
                switch (block.type) {
                    case 'paragraph':
                        return `<p>${processMarkdownLinks(block.value)}</p>`;
                    case 'image':
                        return `<figure>
                                    <img src="${block.value.src}" alt="${block.value.alt}">
                                    <figcaption>${block.value.caption}</figcaption>
                                </figure>`;
                    case 'mermaid':
                        // We wrap in a div for Mermaid to find it
                        return `<div class="mermaid">${block.value}</div>`;
                    case 'kpi-grid':
                        const cards = block.value.map(kpi => `
                            <div class="kpi-card">
                                <div class="value">${kpi.value}</div>
                                <div class="label">${kpi.label}</div>
                            </div>`).join('');
                        return `<div class="kpi-grid">${cards}</div>`;
                    case 'blockquote':
                        return `<blockquote>${block.value.text}<cite>- ${block.value.cite}</cite></blockquote>`;
                    case 'glossary':
                        const glossaryItems = (currentPresentationData?.glossary || []).map(item =>
                            `<dt>${item.term}</dt><dd>${item.definition}</dd>`
                        ).join('');
                        return `<dl class="glossary-list">${glossaryItems}</dl>`;
                    default:
                        return '';
                }
            }

            /**
             * Finds and replaces glossary terms in the text with interactive <dfn> tags.
             * This is done safely by manipulating text nodes, not innerHTML.
             */
            function processGlossary(glossary) {
                if (!glossary || glossary.length === 0) return;

                const walker = document.createTreeWalker(config.contentEl, NodeFilter.SHOW_TEXT, null, false);
                let node;
                const nodesToProcess = [];

                // First, find all text nodes that need changes. We don't change the DOM while iterating.
                while (node = walker.nextNode()) {
                    const hasTerm = glossary.some(item => new RegExp(`\\b${item.term}\\b`, 'i').test(node.nodeValue));
                    if (hasTerm && node.parentElement.tagName !== 'DFN' && node.parentElement.closest('.mermaid') === null) {
                       nodesToProcess.push(node);
                    }
                }
                
                // Now, process the collected nodes
                nodesToProcess.forEach(textNode => {
                    let fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    let text = textNode.nodeValue;

                // Escape special regex characters in terms
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Create a combined regex for all terms to find matches in order
                const termsRegex = new RegExp(`\\b(${glossary.map(g => escapeRegExp(g.term)).join('|')})\\b`, 'gi');
                    
                    text.replace(termsRegex, (match, ...args) => {
                        const offset = args[args.length - 2];
                        const termData = glossary.find(g => g.term.toLowerCase() === match.toLowerCase());
                        
                        // Add text before the match
                        if (offset > lastIndex) {
                            fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
                        }
                        
                        // Add the wrapped term
                        const dfn = document.createElement('dfn');
                        dfn.setAttribute('data-definition', termData.definition);
                        dfn.textContent = match;
                        fragment.appendChild(dfn);

                        lastIndex = offset + match.length;
                    });
                    
                    // Add any remaining text after the last match
                    if (lastIndex < text.length) {
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    }
                    
                    textNode.parentNode.replaceChild(fragment, textNode);
                });
            }

            /**
             * Helper function to resolve CSS variables to actual hex values
             */
            function resolveCssVar(varName) {
                return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            }

            /**
             * Returns current theme colors from CSS variables
             */
            function getCurrentColors() {
                function sanitize(value) {
                    const v = (value || '').trim();
                    if (!v || v === 'undefined' || v === 'null' || v === 'NaN') return '';
                    return v;
                }
                return {
                    primary: sanitize(resolveCssVar('--primary')) || '#2563eb',
                    secondary: sanitize(resolveCssVar('--secondary')) || '#6b7280',
                    background: sanitize(resolveCssVar('--background')) || '#ffffff',
                    surface: sanitize(resolveCssVar('--surface')) || '#f8f9fa',
                    text: sanitize(resolveCssVar('--text')) || '#1a1a1a',
                    textSecondary: sanitize(resolveCssVar('--text-secondary')) || '#6c757d'
                };
            }

            /**
             * Returns the centralized Mermaid configuration object
             */
            function getMermaidConfig() {
                // Determine theme mode, respecting system preference when auto
                const themeAttr = document.documentElement.getAttribute('data-theme');
                let themeMode = 'default';
                if (themeAttr === 'dark') {
                    themeMode = 'dark';
                } else if (themeAttr === 'auto' && window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
                    themeMode = 'dark';
                }

                // Resolve current CSS variables, and if dark mode is in effect, force readable palette
                function sanitizeColorValue(value) {
                    const v = (value || '').trim();
                    if (!v || v === 'undefined' || v === 'null' || v === 'NaN') return '';
                    return v;
                }
                const colors = {
                    primary: sanitizeColorValue(resolveCssVar('--primary')) || '#2563eb',
                    secondary: sanitizeColorValue(resolveCssVar('--secondary')) || '#6b7280',
                    background: sanitizeColorValue(resolveCssVar('--background')) || '#ffffff',
                    surface: sanitizeColorValue(resolveCssVar('--surface')) || '#f8f9fa',
                    text: sanitizeColorValue(resolveCssVar('--text')) || '#1a1a1a',
                    textSecondary: sanitizeColorValue(resolveCssVar('--text-secondary')) || '#6c757d'
                };

                if (themeMode === 'dark') {
                    // Ensure high-contrast defaults in dark mode regardless of page CSS variables
                    colors.background = '#1a1a1a';
                    colors.surface = '#2a2a2a';
                    colors.text = '#ffffff';
                    colors.textSecondary = '#a1a1aa';
                }

                return {
                    startOnLoad: false,
                    theme: themeMode,
                    securityLevel: 'loose',
                    fontFamily: 'var(--pico-font-family)',
                    flowchart: {
                        useMaxWidth: false,
                        htmlLabels: true,
                        curve: 'basis',
                        padding: 16,
                        nodeSpacing: 50,
                        rankSpacing: 60
                    },
                    sequence: {
                        useMaxWidth: false,
                        htmlLabels: true,
                        diagramMarginX: 50,
                        diagramMarginY: 10
                    },
                    gantt: {
                        useMaxWidth: false,
                        htmlLabels: true
                    },
                    pie: {
                        useMaxWidth: true,
                        htmlLabels: true
                    },
                    themeVariables: {
                        primaryColor: colors.primary,
                        primaryTextColor: colors.text,
                        primaryBorderColor: colors.primary,
                        lineColor: colors.primary,
                        sectionBkgColor: colors.surface,
                        altSectionBkgColor: colors.background,
                        gridColor: colors.secondary,
                        tertiaryColor: colors.secondary,
                        edgeLabelBackground: colors.surface,
                        fontSize: '16px',
                        pieTitleTextSize: '20px',
                        pieSectionTextSize: '14px',
                        pieLegendTextSize: '14px'
                    },
                    themeCSS: `
                        /* Essential Mermaid styling for proper rendering */

                        /* Font consistency */
                        .label, .edgeLabel {
                          font-family: var(--pico-font-family);
                        }

                        /* Node styling - provide sensible defaults but allow diagram overrides */
                        .node rect, .node polygon, .node path, .node circle, .node ellipse {
                          fill: ${colors.surface};
                          stroke: ${colors.primary};
                          stroke-width: 2px;
                        }
                        .node rect { rx: 8; ry: 8; }

                        /* Text elements - defaults, can be overridden by diagram styles or post-render adjuster */
                        .label text, .nodeLabel, .edgeLabel text {
                          fill: ${colors.text};
                          font-weight: 500;
                        }
                        /* Flowchart HTML labels (Mermaid uses <foreignObject>) */
                        .label foreignObject div, .nodeLabel foreignObject div, .edgeLabel foreignObject div {
                          color: ${colors.text};
                        }

                        /* Flowchart connections */
                        .edgePath path, .flowchart-link {
                          stroke: ${colors.primary};
                          stroke-width: 2px;
                        }
                        .edgePath .arrowheadPath, .arrowheadPath {
                          fill: ${colors.primary};
                          stroke: ${colors.primary};
                        }

                        /* Light brand touch for flowcharts */
                        .flowchart .node rect {
                          stroke: ${colors.primary};
                          stroke-width: 2px;
                          rx: 8;
                          ry: 8;
                        }

                        /* Sequence diagram styling */
                        .sequence .actor {
                          stroke: ${colors.primary};
                          fill: ${colors.surface};
                        }
                        .sequence .actor-line {
                          stroke: ${colors.primary};
                        }
                        .sequence .messageLine {
                          stroke: ${colors.primary};
                        }

                        /* Gantt chart styling */
                        .gantt .section {
                          stroke: ${colors.primary};
                        }
                        .gantt .grid .tick line {
                          stroke: ${colors.secondary};
                        }

                        /* Ensure text is readable */
                        .label text, .nodeLabel, .edgeLabel text {
                          font-weight: 500;
                        }

                        /* Global default */
                        text, tspan { fill: ${colors.text}; }

                        /* Pie specific: title and legend use current text color (allow external overrides) */
                        g.legend text, .pieTitleText {
                          fill: ${colors.text};
                        }
                    `
                };
            }

            /**
             * Initializes Mermaid.js to render all diagrams
             */
            function initializeMermaid() {
                // Wait for Mermaid to be loaded
                if (typeof mermaid === 'undefined') { setTimeout(initializeMermaid, 100); return; }

                // Initialize Mermaid with centralized configuration
                mermaid.initialize(getMermaidConfig());

                // Manually render all mermaid diagrams
                setTimeout(renderMermaidDiagrams, 100);
            }

            /**
             * Manually render all Mermaid diagrams in the page
             */
            function renderMermaidDiagrams() {
                const mermaidElements = document.querySelectorAll('.mermaid');
                if (mermaidElements.length === 0) return;

                mermaidElements.forEach((element, index) => {
                    // Skip if already processed
                    if (element.hasAttribute('data-processed')) return;

                    const graphDefinition = element.textContent.trim();
                    if (!graphDefinition) return;

                    try {
                        // Use the older Mermaid API for better compatibility
                        mermaid.render(`mermaid-${Date.now()}-${index}`, graphDefinition, (svgCode) => {
                            element.innerHTML = svgCode;
                            // Post-process for contrast after rendering
                            try { adjustMermaidContrastForContainer(element); } catch (e) {}
                            element.setAttribute('data-processed', 'true');
                            // Store original definition for modal and re-rendering use
                            // Encode to prevent any corruption
                            element.setAttribute('data-original-definition', btoa(encodeURIComponent(graphDefinition)));
                        }, element);
                    } catch (error) {
                        element.innerHTML = `<div style="background: var(--pico-code-background-color); padding: 1rem; border-radius: var(--pico-border-radius); border: 1px solid var(--pico-code-border-color);">
                            <div style="color: var(--pico-del-color); margin-bottom: 0.5rem;">⚠️ Diagram rendering failed</div>
                            <pre style="margin: 0; font-size: 0.85em; white-space: pre-wrap;">${graphDefinition.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}</pre>
                        </div>`;
                    }
                });
            }

            /**
             * Sets up scroll listeners for progress bar and active TOC highlighting
             */
            function setupEventListeners(sections) {
                const sectionsEls = document.querySelectorAll('.animated-section');
                const tocLinks = document.querySelectorAll('#toc-nav a');

                // Intersection Observer for animations
                const animationObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            animationObserver.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                sectionsEls.forEach(section => animationObserver.observe(section));

                // Intersection Observer for TOC highlighting
                const tocObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const id = entry.target.getAttribute('id');
                            tocLinks.forEach(link => {
                                link.classList.toggle('active', link.getAttribute('data-section-id') === id);
                            });
                        }
                    });
                }, { rootMargin: '-50% 0px -50% 0px' });
                // Now observe sections AND subsections for highlighting
                document.querySelectorAll('section[id], article[id]').forEach(section => tocObserver.observe(section));

                // Scroll listener for progress bar (throttled for performance)
                window.addEventListener('scroll', throttle(() => {
                    const scrollTotal = document.documentElement.scrollHeight - window.innerHeight;
                    const scrollPercentage = (window.scrollY / scrollTotal) * 100;
                    config.progressBarEl.style.width = `${scrollPercentage}%`;
                }, 16), { signal: abortController.signal, passive: true });

                // Navigation controls
                setupNavigationControls(sections);

                // Keyboard shortcuts
                setupKeyboardNavigation(sections);

                // Theme toggle
                setupThemeToggle();

                // Fullscreen toggle
                setupFullscreenToggle();

                

                // File upload
                setupFileUpload();


            }



            /**
             * Sets up navigation controls
             */
            function setupNavigationControls(sections) {
                const prevBtn = document.getElementById('prev-section');
                const nextBtn = document.getElementById('next-section');

                if (!prevBtn || !nextBtn) return;

                let currentSectionIndex = 0;
                const sectionElements = document.querySelectorAll('section[id], article[id]');

                function updateNavigationButtons() {
                    const scrollTop = window.pageYOffset;
                    const windowHeight = window.innerHeight;

                    // Find current section based on scroll position
                    for (let i = sectionElements.length - 1; i >= 0; i--) {
                        const section = sectionElements[i];
                        const rect = section.getBoundingClientRect();
                        if (rect.top <= windowHeight * 0.5) {
                            currentSectionIndex = i;
                            break;
                        }
                    }

                    prevBtn.style.opacity = currentSectionIndex > 0 ? '1' : '0.5';
                    nextBtn.style.opacity = currentSectionIndex < sectionElements.length - 1 ? '1' : '0.5';
                }

                function navigateToSection(index) {
                    if (index >= 0 && index < sectionElements.length) {
                        const targetSection = sectionElements[index];
                        targetSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }

                prevBtn.addEventListener('click', () => {
                    // Linear mode: go to previous section
                    if (currentSectionIndex > 0) {
                        navigateToSection(currentSectionIndex - 1);
                    }
                });

                nextBtn.addEventListener('click', () => {
                    // Linear mode: go to next section
                    if (currentSectionIndex < sectionElements.length - 1) {
                        navigateToSection(currentSectionIndex + 1);
                    }
                });

                window.addEventListener('scroll', throttle(updateNavigationButtons, 100), { signal: abortController.signal, passive: true });
                updateNavigationButtons();
            }

            /**
             * Sets up keyboard navigation
             */
            function setupKeyboardNavigation(sections) {
                const sectionElements = document.querySelectorAll('section[id], article[id]');
                let currentSectionIndex = 0;

                function navigateToSection(index) {
                    if (index >= 0 && index < sectionElements.length) {
                        const targetSection = sectionElements[index];
                        targetSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        currentSectionIndex = index;
                    }
                }

                document.addEventListener('keydown', (e) => {
                    // Only handle keyboard navigation when not typing in inputs
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    // Linear mode navigation
                    switch (e.key) {
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            if (currentSectionIndex > 0) {
                                navigateToSection(currentSectionIndex - 1);
                            }
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                        case ' ':
                            e.preventDefault();
                            if (currentSectionIndex < sectionElements.length - 1) {
                                navigateToSection(currentSectionIndex + 1);
                            }
                            break;
                        case 'Home':
                            e.preventDefault();
                            navigateToSection(0);
                            break;
                        case 'End':
                            e.preventDefault();
                            navigateToSection(sectionElements.length - 1);
                            break;
                    }
                }, { signal: abortController.signal });

                // Update current section index on scroll
                window.addEventListener('scroll', () => {
                    const scrollTop = window.pageYOffset;
                    const windowHeight = window.innerHeight;

                    for (let i = sectionElements.length - 1; i >= 0; i--) {
                        const section = sectionElements[i];
                        const rect = section.getBoundingClientRect();
                        if (rect.top <= windowHeight * 0.5) {
                            currentSectionIndex = i;
                            break;
                        }
                    }
                }, { signal: abortController.signal, passive: true });
            }

            /**
             * Sets up fullscreen toggle functionality
             */
            function setupFullscreenToggle() {
                const fullscreenBtn = document.getElementById('fullscreen-toggle');
                if (!fullscreenBtn) return;

                let isFullscreen = false;

                function toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().then(() => {
                            isFullscreen = true;
                            updateFullscreenButton();
                            document.body.classList.add('presentation-mode');
                        }).catch(() => {});
                    } else {
                        document.exitFullscreen().then(() => {
                            isFullscreen = false;
                            updateFullscreenButton();
                            document.body.classList.remove('presentation-mode');
                        }).catch(() => {});
                    }
                }

                function updateFullscreenButton() {
                    const icon = fullscreenBtn.querySelector('svg');
                    if (isFullscreen) {
                        icon.innerHTML = '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0 2-2h3M3 16h3a2 2 0 0 0 2 2v3"></path>';
                    } else {
                        icon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>';
                    }
                }

                fullscreenBtn.addEventListener('click', toggleFullscreen);

                // Handle fullscreen changes (e.g., ESC key)
                document.addEventListener('fullscreenchange', () => {
                    isFullscreen = !!document.fullscreenElement;
                    updateFullscreenButton();
                    if (isFullscreen) {
                        document.body.classList.add('presentation-mode');
                    } else {
                        document.body.classList.remove('presentation-mode');
                    }
                });

                // Add F key support for fullscreen
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'f' || e.key === 'F') {
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            toggleFullscreen();
                        }
                    }
                }, { signal: abortController.signal });
            }

            /**
             * Sets up theme toggle functionality
             */
            function setupThemeToggle() {
                const themeBtn = document.getElementById('theme-toggle');
                if (!themeBtn) return;

                let currentTheme = document.documentElement.getAttribute('data-theme') || 'auto';

                function updateThemeButton() {
                    const icon = themeBtn.querySelector('svg');
                    if (currentTheme === 'dark') {
                        icon.innerHTML = '<path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"></path>';
                        themeBtn.setAttribute('title', 'Switch to Light Mode (T)');
                    } else {
                        icon.innerHTML = '<path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>';
                        themeBtn.setAttribute('title', 'Switch to Dark Mode (T)');
                    }
                }

                function toggleTheme() {
                    if (currentTheme === 'dark') {
                        currentTheme = 'light';
                    } else if (currentTheme === 'light') {
                        currentTheme = 'auto';
                    } else {
                        currentTheme = 'dark';
                    }

                    document.documentElement.setAttribute('data-theme', currentTheme);
                    updateThemeButton();

                    // Apply theme to all UI elements (not just Mermaid)
                    // Use predefined theme colors based on mode
                    const themeData = getThemeForMode(currentTheme);
                    applyTheme(themeData);

                    // Store preference in localStorage
                    localStorage.setItem('preferred-theme', currentTheme);
                }

                function getThemeForMode(mode) {
                    // Use the presentation's defined colors, just change light/dark variants
                    let presentationColors = currentPresentationData?.theme?.colors;

                    // Fallback to current CSS variables if presentation data not available
                    if (!presentationColors) {
                        presentationColors = {
                            primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#00853F',
                            secondary: getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim() || '#64748b'
                        };
                    }

                    if (mode === 'dark') {
                        return {
                            mode: 'dark',
                            colors: {
                                primary: presentationColors.primary,
                                secondary: presentationColors.secondary,
                                background: '#1a1a1a',
                                surface: '#2a2a2a',
                                text: '#ffffff',
                                textSecondary: '#a1a1aa'
                            }
                        };
                    } else if (mode === 'light') {
                        return {
                            mode: 'light',
                            colors: {
                                primary: presentationColors.primary,
                                secondary: presentationColors.secondary,
                                background: '#f8fafc',
                                surface: '#ffffff',
                                text: '#1e293b',
                                textSecondary: '#64748b'
                            }
                        };
                    } else { // auto
                        return {
                            mode: 'auto',
                            colors: {
                                primary: presentationColors.primary,
                                secondary: presentationColors.secondary,
                                background: '#f8fafc',
                                surface: '#ffffff',
                                text: '#1e293b',
                                textSecondary: '#64748b'
                            }
                        };
                    }
                }

                themeBtn.addEventListener('click', toggleTheme);

                // Load saved preference
                const savedTheme = localStorage.getItem('preferred-theme');
                if (savedTheme) {
                    currentTheme = savedTheme;
                    document.documentElement.setAttribute('data-theme', currentTheme);

                    // Apply the saved theme to CSS variables
                    const themeData = getThemeForMode(currentTheme);
                    applyTheme(themeData);
                }

                updateThemeButton();

                // Add T key support for theme toggle
                document.addEventListener('keydown', (e) => {
                    if (e.key === 't' || e.key === 'T') {
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            toggleTheme();
                        }
                    }
                }, { signal: abortController.signal });
            }

            /**
             * Re-renders all Mermaid diagrams with current theme
             */
            function reRenderMermaidDiagrams() {
                // Re-initialize Mermaid with centralized configuration
                mermaid.initialize(getMermaidConfig());

                // Clear processed flags and re-render all diagrams
                document.querySelectorAll('.mermaid').forEach(el => {
                    el.removeAttribute('data-processed');
                    // Put back the original Mermaid syntax
                    const encodedDefinition = el.getAttribute('data-original-definition');
                    if (encodedDefinition) {
                        try {
                            // Decode the stored definition
                            const originalDefinition = decodeURIComponent(atob(encodedDefinition));
                            el.innerHTML = originalDefinition;
                            el.removeAttribute('data-original-definition'); // Clear for re-storage
                        } catch (e) { el.innerHTML = el.textContent || ''; }
                    } else { el.setAttribute('data-processed', 'true'); return; }
                });

                // Force re-render all diagrams
                setTimeout(() => {
                    const mermaidElements = document.querySelectorAll('.mermaid');
                    mermaidElements.forEach((element, index) => {
                        // Use innerHTML content which should now contain the original Mermaid syntax
                        const graphDefinition = element.innerHTML.trim();
                        if (!graphDefinition) return;

                        try {
                            mermaid.render(`mermaid-${Date.now()}-${index}`, graphDefinition, (svgCode) => {
                                element.innerHTML = svgCode;
                                // Post-process for contrast after re-render
                                try { adjustMermaidContrastForContainer(element); } catch (e) {}
                                element.setAttribute('data-processed', 'true');
                                element.setAttribute('data-original-definition', btoa(encodeURIComponent(graphDefinition)));
                            }, element);
                        } catch (error) {
                            element.innerHTML = `<div style="background: var(--pico-code-background-color); padding: 1rem; border-radius: var(--pico-border-radius); border: 1px solid var(--pico-code-border-color);">
                                <div style="color: var(--pico-del-color); margin-bottom: 0.5rem;">⚠️ Diagram re-rendering failed</div>
                                <pre style="margin: 0; font-size: 0.85em; white-space: pre-wrap;">${graphDefinition.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}</pre>
                            </div>`;
                        }
                    });
                }, 100);
            }

            /**
             * Contrast adjustment for Mermaid diagrams: ensure text contrasts with node backgrounds
             */
            function adjustMermaidContrastForContainer(container) {
                const svg = container.querySelector('svg');
                if (!svg) return;
                adjustMermaidContrastInSvg(svg);
            }

            function adjustMermaidContrastInSvg(svg) {
                function parseColorToRgbTuple(color) {
                    const c = (color || '').trim();
                    if (!c) return null;
                    if (/^rgba?\(/i.test(c)) {
                        const parts = c.replace(/^rgba?\(/i, '').replace(/\)\s*$/i, '').split(',').map(p => parseFloat(p.trim()));
                        return { r: parts[0] || 0, g: parts[1] || 0, b: parts[2] || 0 };
                    }
                    const short = /^#([a-f\d])([a-f\d])([a-f\d])$/i.exec(c);
                    if (short) {
                        return {
                            r: parseInt(short[1] + short[1], 16),
                            g: parseInt(short[2] + short[2], 16),
                            b: parseInt(short[3] + short[3], 16)
                        };
                    }
                    const full = /^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c);
                    if (full) {
                        return {
                            r: parseInt(full[1], 16),
                            g: parseInt(full[2], 16),
                            b: parseInt(full[3], 16)
                        };
                    }
                    return null;
                }

                function toLinear(channel) {
                    const s = channel / 255;
                    return s <= 0.03928 ? s / 12.92 : Math.pow((s + 0.055) / 1.055, 2.4);
                }

                function relativeLuminance(r, g, b) {
                    const R = toLinear(r), G = toLinear(g), B = toLinear(b);
                    return 0.2126 * R + 0.7152 * G + 0.0722 * B;
                }

                function contrastRatio(l1, l2) {
                    const a = Math.max(l1, l2);
                    const b = Math.min(l1, l2);
                    return (a + 0.05) / (b + 0.05);
                }

                function adjustGroup(groupSelector, shapeSelector) {
                    svg.querySelectorAll(groupSelector).forEach(group => {
                        const shape = group.querySelector(shapeSelector);
                        if (!shape) return;
                        let fill = window.getComputedStyle(shape).fill;
                        if (!fill || fill === 'none') {
                            fill = shape.getAttribute('fill') || '';
                        }
                        const rgb = parseColorToRgbTuple(fill);
                        if (!rgb) return;
                        const lBg = relativeLuminance(rgb.r, rgb.g, rgb.b);
                        const blackContrast = contrastRatio(lBg, 0);
                        const whiteContrast = contrastRatio(lBg, 1);
                        const useWhite = whiteContrast >= blackContrast;
                        const desired = useWhite ? '#ffffff' : '#111111';

                        group.querySelectorAll('text').forEach(t => {
                            try { t.style.setProperty('fill', desired, 'important'); } catch (_) {}
                        });
                        group.querySelectorAll('foreignObject div').forEach(d => {
                            try { d.style.setProperty('color', desired, 'important'); } catch (_) {}
                        });
                    });
                }

                adjustGroup('g.node', 'rect, polygon, path, circle, ellipse');
                adjustGroup('g.cluster', 'rect');
                adjustGroup('g.edgeLabel', 'rect');
                // Pie slices
                adjustGroup('g.section', 'path');

                // Dedicated handling for Mermaid pie charts (slices and their labels)
                (function adjustPieSlices() {
                    const sliceGroups = svg.querySelectorAll('g.slice, g.arc, g[class*="slice" i], g[class*="arc" i]');
                    sliceGroups.forEach(group => {
                        const path = group.querySelector('path');
                        if (!path) return;
                        let fill = window.getComputedStyle(path).fill || path.getAttribute('fill') || '';
                        const rgb = parseColorToRgbTuple(fill);
                        if (!rgb) return;
                        const lBg = relativeLuminance(rgb.r, rgb.g, rgb.b);
                        const blackContrast = contrastRatio(lBg, 0);
                        const whiteContrast = contrastRatio(lBg, 1);
                        const useWhite = whiteContrast >= blackContrast;
                        const desired = useWhite ? '#ffffff' : '#111111';
                        group.querySelectorAll('text').forEach(t => {
                            try { t.style.setProperty('fill', desired, 'important'); } catch (_) {}
                        });
                    });
                })();
            }

            

            /**
             * Sets up file upload functionality
             */
            function setupFileUpload() {
                const uploadBtn = document.getElementById('upload-json');
                const fileInput = document.getElementById('json-file-input');

                if (!uploadBtn || !fileInput) return;

                // Handle upload button click
                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                // Handle file selection
                fileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    // Check file type
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        alert('Please select a JSON file.');
                        return;
                    }

                    try {
                        // Show loading state
                        const loadingIndicator = document.getElementById('loading-indicator');
                        loadingIndicator.style.display = 'block';
                        uploadBtn.style.opacity = '0.5';
                        uploadBtn.disabled = true;

                        // Read file content
                        const fileContent = await readFileAsText(file);
                        const jsonData = JSON.parse(fileContent);

                        // Validate basic structure
                        if (!jsonData.title || !jsonData.sections) {
                            throw new Error('Invalid presentation format. Missing required fields.');
                        }

                        // Reload presentation with new data (navigation processing happens in reloadPresentation)
                        await reloadPresentation(jsonData);

                        

                    } catch (error) {
                        alert(`Error loading presentation file: ${error.message}`);
                    } finally {
                        // Reset loading state
                        const loadingIndicator = document.getElementById('loading-indicator');
                        loadingIndicator.style.display = 'none';
                        uploadBtn.style.opacity = '1';
                        uploadBtn.disabled = false;
                        fileInput.value = ''; // Reset file input
                    }
                });

                // Add keyboard shortcut (Ctrl+U)
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                        e.preventDefault();
                        fileInput.click();
                    }
                }, { signal: abortController.signal });
            }




            /**
             * Reads a file as text using FileReader API
             */
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            /**
             * Modal functionality for images and Mermaid diagrams
             */
            function setupModalFunctionality() {
                const modal = document.getElementById('modal-overlay');
                const modalBody = document.getElementById('modal-body');
                const modalClose = document.getElementById('modal-close');

                // Close modal when clicking the close button
                modalClose.addEventListener('click', () => {
                    modal.classList.remove('show');
                    modalBody.innerHTML = '';
                });

                // Close modal when clicking outside the content
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        modalBody.innerHTML = '';
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('show')) {
                        modal.classList.remove('show');
                        modalBody.innerHTML = '';
                    }
                }, { signal: abortController.signal });
            }

            /**
             * Make images clickable for modal display (using event delegation)
             */
            function makeImagesClickable() {
                // Use event delegation to avoid re-binding handlers on reload
                document.addEventListener('click', (e) => {
                    if (e.target.matches('figure img')) {
                        const modal = document.getElementById('modal-overlay');
                        const modalBody = document.getElementById('modal-body');
                        const figcaption = e.target.closest('figure').querySelector('figcaption');

                        modalBody.innerHTML = `
                            <img src="${e.target.src}" alt="${e.target.alt}" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                            ${figcaption ? `<p style="margin-top: 1rem; color: var(--pico-secondary); font-style: italic;">${figcaption.textContent}</p>` : ''}
                        `;

                        modal.classList.add('show');
                    }
                }, { signal: abortController.signal });
            }

            /**
             * Make Mermaid diagrams clickable for modal display (using event delegation)
             */
            function makeMermaidClickable() {
                // Use event delegation to avoid re-binding handlers on reload
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.mermaid')) {
                        const diagram = e.target.closest('.mermaid');
                        const modal = document.getElementById('modal-overlay');
                        const modalBody = document.getElementById('modal-body');

                        // APPROCHE SIMPLIFIÉE: Cloner le SVG existant au lieu de le rerendre
                        const existingSvg = diagram.querySelector('svg');
                        if (existingSvg) {

                            // Create modal container
                            const modalDiagram = document.createElement('div');
                            modalDiagram.className = 'mermaid-modal';
                            modalDiagram.style.background = 'var(--surface)';
                            modalDiagram.style.padding = '1rem';
                            modalDiagram.style.borderRadius = '12px';

                            // Clone the SVG
                            const clonedSvg = existingSvg.cloneNode(true);

                            // Make it bigger for the modal
                            clonedSvg.style.width = 'min(96vw, 1400px)';
                            clonedSvg.style.height = 'auto';
                            clonedSvg.style.display = 'block';
                            clonedSvg.style.margin = '0 auto';
                            clonedSvg.style.maxHeight = '80vh';

                            // Add title if it exists
                            const title = diagram.querySelector('h2, h3, h4');
                            if (title) {
                                const titleClone = title.cloneNode(true);
                                titleClone.style.textAlign = 'center';
                                titleClone.style.marginBottom = '1rem';
                                modalDiagram.appendChild(titleClone);
                            }

                            // Add the cloned SVG
                            modalDiagram.appendChild(clonedSvg);

                            // Show modal
                            modalBody.innerHTML = '';
                            modalBody.appendChild(modalDiagram);
                            modal.classList.add('show');
                        } else {
                            modalBody.innerHTML = '<div style="color: red; padding: 1rem;">Erreur: Aucun SVG trouvé</div>';
                            modal.classList.add('show');
                        }
                    }
                }, { signal: abortController.signal });
            }

            /**
             * Setup all interactive elements after content is loaded
             */
            function setupInteractiveElements() {
                setupModalFunctionality();
                makeImagesClickable();
                makeMermaidClickable();
            }

            // Start the application
            init().catch(() => {});
        });
    </script>
    
    <!--
        Embedded Presentation JSON Schema
        - Purpose: Make the schema available directly in the single-file build (no extra downloads).
        - Visibility: Not used by the UI; just present in source for reference/validation tooling.
        - Usage: View source and copy the JSON below if you need the schema.
        - Note: Keep as-is to avoid extra network requests and preserve single-file setup.
    -->
    <script type="application/schema+json" id="presentation-schema">
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Narrative Presentation Schema",
  "description": "🎨 Complete presentation system with 6-color theme palette. Easily customize colors for buttons, diagrams, text, and backgrounds. Auto-adapts to light/dark themes.",
  "type": "object",
  "properties": {
    "title": {
      "type": "string",
      "description": "The overall title of the presentation, used for the browser tab."
    },
    "theme": {
      "type": "object",
      "description": "🎨 Complete theme system with 6 core colors. Automatically adapts all UI elements including Mermaid diagrams, buttons, hero section, and navigation.",
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "light",
            "dark",
            "auto"
          ],
          "description": "Theme mode. 'auto' detects system preference. Toggle with T key or theme button.",
          "default": "auto",
          "examples": [
            "auto",
            "light",
            "dark"
          ]
        },
        "colors": {
          "type": "object",
          "description": "📋 6-color palette - the only colors you need to customize your entire presentation!",
          "properties": {
            "primary": {
              "type": "string",
              "format": "color",
              "description": "🔵 Main brand color - buttons, links, accents, Mermaid diagram elements",
              "example": "#2563eb",
              "default": "#2563eb"
            },
            "secondary": {
              "type": "string",
              "format": "color",
              "description": "⚪ Secondary color - borders, muted elements, supporting UI",
              "example": "#6b7280",
              "default": "#6b7280"
            },
            "background": {
              "type": "string",
              "format": "color",
              "description": "🏠 Main page background - hero section, body background",
              "example": "#ffffff",
              "default": "#ffffff"
            },
            "surface": {
              "type": "string",
              "format": "color",
              "description": "📦 Card/surface background - Mermaid containers, highlight cards",
              "example": "#f8f9fa",
              "default": "#f8f9fa"
            },
            "text": {
              "type": "string",
              "format": "color",
              "description": "📝 Primary text color - headings, main content",
              "example": "#1a1a1a",
              "default": "#1a1a1a"
            },
            "text-secondary": {
              "type": "string",
              "format": "color",
              "description": "📝 Secondary text color - descriptions, muted text",
              "example": "#6c757d",
              "default": "#6c757d"
            }
          },
          "additionalProperties": false,
          "required": [
            "primary",
            "secondary",
            "background",
            "surface",
            "text",
            "text-secondary"
          ]
        }
      },
      "examples": [
        {
          "description": "✨ Default Light Theme",
          "mode": "light",
          "colors": {
            "primary": "#2563eb",
            "secondary": "#6b7280",
            "background": "#ffffff",
            "surface": "#f8f9fa",
            "text": "#1a1a1a",
            "text-secondary": "#6c757d"
          }
        },
        {
          "description": "🌙 Professional Dark Theme",
          "mode": "dark",
          "colors": {
            "primary": "#60a5fa",
            "secondary": "#9ca3af",
            "background": "#1a1a1a",
            "surface": "#2a2a2a",
            "text": "#ffffff",
            "text-secondary": "#9ca3af"
          }
        },
        {
          "description": "🌈 Custom Brand Colors",
          "mode": "auto",
          "colors": {
            "primary": "#e11d48",
            "secondary": "#64748b",
            "background": "#fefefe",
            "surface": "#f1f5f9",
            "text": "#0f172a",
            "text-secondary": "#64748b"
          }
        }
      ]
    },
    "navigation": {
      "type": "object",
      "description": "Navigation configuration for custom section order",
      "properties": {
        "order": {
          "type": "array",
          "description": "Array of section/subsection IDs defining custom navigation order",
          "items": {
            "type": "string",
            "description": "Section or subsection ID that must exist in the presentation"
          }
        }
      },
      "additionalProperties": false
    },
    "hero": {
      "type": "object",
      "properties": {
        "title": {
          "type": "string"
        },
        "subtitle": {
          "type": "string"
        },
        "highlights": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "metric": {
                "type": "string"
              },
              "value": {
                "type": "string"
              },
              "label": {
                "type": "string"
              }
            },
            "required": [
              "metric",
              "value",
              "label"
            ]
          }
        },
        "callToAction": {
          "type": "object",
          "properties": {
            "text": {
              "type": "string"
            },
            "link": {
              "type": "string",
              "description": "A link URL - either an anchor link (e.g., '#section-id') or external URL (e.g., 'https://example.com')"
            }
          },
          "required": [
            "text",
            "link"
          ]
        },
        "callToActions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "text": {
                "type": "string"
              },
              "link": {
                "type": "string",
                "description": "An anchor link, e.g., '#section-id'"
              },
              "primary": {
                "type": "boolean",
                "description": "Whether this is the primary action button"
              }
            },
            "required": [
              "text",
              "link"
            ]
          }
        }
      },
      "required": [
        "title",
        "subtitle"
      ]
    },
    "glossary": {
      "type": "array",
      "description": "A list of terms and definitions for automatic highlighting and tooltips.",
      "items": {
        "type": "object",
        "properties": {
          "term": {
            "type": "string"
          },
          "definition": {
            "type": "string"
          }
        },
        "required": [
          "term",
          "definition"
        ]
      }
    },
    "sections": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/section"
      }
    }
  },
  "required": [
    "title",
    "sections"
  ],
  "definitions": {
    "contentBlock": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "paragraph",
            "image",
            "mermaid",
            "kpi-grid",
            "blockquote",
            "glossary"
          ]
        }
      },
      "required": [
        "type"
      ],
      "oneOf": [
        {
          "properties": {
            "type": {
              "const": "paragraph"
            },
            "value": {
              "type": "string"
            }
          },
          "required": [
            "value"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "image"
            },
            "value": {
              "type": "object",
              "properties": {
                "src": {
                  "type": "string",
                  "format": "uri"
                },
                "alt": {
                  "type": "string"
                },
                "caption": {
                  "type": "string"
                }
              },
              "required": [
                "src",
                "alt"
              ]
            }
          },
          "required": [
            "value"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "mermaid"
            },
            "value": {
              "type": "string",
              "description": "Valid Mermaid.js syntax. Diagrams automatically adapt to the current theme (light/dark/auto). Lines, nodes, and text colors are themed to match the presentation colors. Supported diagram types: flowchart, sequence, gantt, pie, and more."
            }
          },
          "required": [
            "value"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "kpi-grid"
            },
            "value": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "label": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string"
                  }
                },
                "required": [
                  "label",
                  "value"
                ]
              }
            }
          },
          "required": [
            "value"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "blockquote"
            },
            "value": {
              "type": "object",
              "properties": {
                "text": {
                  "type": "string"
                },
                "cite": {
                  "type": "string"
                }
              },
              "required": [
                "text"
              ]
            }
          },
          "required": [
            "value"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "glossary"
            }
          },
          "description": "A placeholder block that will be automatically populated with the glossary."
        }
      ]
    },
    "subsection": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique ID for anchor linking."
        },
        "title": {
          "type": "string"
        },
        "content": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/contentBlock"
          }
        }
      },
      "required": [
        "id",
        "title",
        "content"
      ]
    },
    "section": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique ID for anchor linking."
        },
        "title": {
          "type": "string"
        },
        "content": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/contentBlock"
          }
        },
        "subsections": {
          "type": "array",
          "description": "An optional array of subsections for creating a hierarchy.",
          "items": {
            "$ref": "#/definitions/subsection"
          }
        }
      },
      "required": [
        "id",
        "title",
        "content"
      ]
    }
  }
}
    </script>
</body>
</html>









